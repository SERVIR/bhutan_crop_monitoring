{% extends "WebApp/app_base.html" %}

{% load static %}

{% block title %}Bhutan Crop Monitoring - Map{% endblock %}
{% block script %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css"
          integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
    {#    <link rel="stylesheet" href="{% static '/js/jquery-ui.min.css' %}">#}

    <link rel="stylesheet" href="{% static '/css/yearpicker.css' %}">
    <script src="{% static '/js/yearpicker.js' %}" async></script>
    <!-- CSS -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css" rel="stylesheet">

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
          integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin=""/>
    <link rel="stylesheet"
          href="{% static '/css/leaflet-sidebar.css' %}"
    />
    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
            integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"
            integrity="sha512-E0DKVahIg0p1UHR2Kf9NX7x7TUewJb30mxkxEm2qOYTVJObgsAGpEol9F6iK6oefCbkJiA4/i6fnTHzM6H1kEA=="
            crossorigin=""></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4/dist/esri-leaflet-vector.js"></script>

    <script src="{% static 'js/leaflet-side-by-side.js' %}"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
    {#    <script src="{% static '/js/L.Control.Opacity.js' %}"></script>#}
    {#    <link href="{% static '/css/L.Control.Opacity.css' %}" rel="stylesheet"/>#}
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-search/3.0.5/leaflet-search.src.js"
            integrity="sha512-PDM7dpetuBcPp2fV/ZyCj9BGV8ybPchsrSzQqVZ3WoM8YcxEa2lAj0n1+4MCRzgsEROmVTwQXGw0IrXCCgH+/Q=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{% static '/js/jquery-ui.min.js' %}"></script>
    {#    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>#}
    {#    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>#}

    {#    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>#}
    <script src="{% static '/js/leaflet-providers.js' %}"></script>
    {#    <script src="{% static 'js/boundary.js' %}"></script>#}

    <script src="{% static 'js/utils.js' %}"></script>

    <script src="{% static 'js/basemaps.js' %}"></script>
    <script src="{% static 'js/base-layers.js' %}"></script>
    <script src="{% static '/js/geosearch.umd.js' %}"></script>
    <link
            rel="stylesheet"
            href="{% static '/css/geosearch.css' %}"
    />


    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

    <script>
        const static_url = "{% static '' %}";
        let active_basemap = "Gsatellite";
        let overlayMaps = {};
        let piechart;
        let client_layers = [];
        var the_picker;
        var dzongkhagLayer;
        var gewog_features;
        var full_data = {{ full_data|safe }};
        var boundary = {{ boundary|safe }};

        {% for layer in data_layers %}
            client_layers.push({
                title: "{{ layer.title }}",
                url: "{{ layer.url }}",
                attribution: "{{ layer.attribution }}",
                layers: "{{ layer.layers }}",
                styles: "{{ layer.default_style }}",
                colorrange: "{{ layer.default_color_range }}",
                overrange: "{{ layer.overrange }}",
                belowrange: "{{ layer.belowrange }}",
                id: "{{ layer.ui_id }}",
                default_year: "{{ layer.default_year }}",
                default_on: "{{ layer.default_on }}"
            })
        {% endfor %}

        // Function to update chart dimensions
        function updateChartDimensions() {
            // Get the width of the container element
            const containerWidth = document.getElementById('pie_chart').clientWidth;

            // Calculate height based on the container width and aspect ratio
            const aspectRatio = 16 / 9;
            const height = containerWidth / aspectRatio;

            // Update the chart dimensions
            piechart.setSize(containerWidth, height);
        }

        window.addEventListener('resize', function () {
            updateChartDimensions();
        });

        function buildPie() {
            // Get the width of the container element
            const containerWidth = document.getElementById('pie_chart').clientWidth;

// Calculate height based on the container width and aspect ratio
            const aspectRatio = 16 / 9;
            const height = containerWidth / aspectRatio;
            piechart = Highcharts.chart('pie_chart', {
                chart: {
                    type: 'pie',
                    height: height,
                    width: containerWidth
                },
                title: {
                    text: 'Rice area distribution in acres by Dzongkhag'
                },
                tooltip: {
                    useHTML: true,
                    headerFormat: '<table>',
                    footerFormat: '</table>',
                    pointFormatter: function () {
                        let dataSum = 0,
                            percentage;

                        this.series.points.forEach(function (point) {
                            dataSum += point.y;
                        });

                        percentage = ((this.y / dataSum) * 100).toFixed(2);

                        return `<tr><th colspan="2"><b>${this.name}</b></th></tr>
             <tr><th>Value:</th><td>${this.y} acres</td></tr>
             <tr><th>Percent:</th><td>${percentage}%</td></tr>`
                    }
                },
                series: [
                    {
                        name: 'Percentage',
                        colorByPoint: true,
                        data: [
                            {
                                name: 'District 1',
                                y: 4100.123
                            },
                            {
                                name: 'District 2',
                                y: 3240.2
                            },
                            {
                                name: 'District 3',
                                y: 2345.12
                            },
                            {
                                name: 'District 4',
                                y: 1345.0
                            },
                            {
                                name: 'District 5',
                                y: 500.25
                            },
                            {
                                name: 'District 6',
                                y: 1.68
                            }
                        ]
                    }
                ]
            });
        }

        function buildChart(id, title, subtitle, type, pointStart, yAxisText, rangeDescription, seriesObject, color) {
            Highcharts.chart(id, {
                    chart: {
                        type: type
                    },
                    colors: color,
                    title: {
                        text: title,
                        align: 'left'
                    },

                    yAxis: {
                        title: {
                            text: yAxisText
                        }
                    },

                    xAxis: {
                        accessibility: {
                            rangeDescription: rangeDescription
                        }
                    },

                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle'
                    },

                    plotOptions: {
                        series: {
                            label: {
                                connectorAllowed: false
                            },
                            pointStart: pointStart,
                            tooltip: {
                                pointFormatter: function () {
                                    return this.y + " " + yAxisText;

                                }
                            },
                        }
                    },

                    series: seriesObject,

                    responsive: {
                        rules: [{
                            condition: {
                                width: '100%',
                            },
                            chartOptions: {
                                legend: {
                                    layout: 'horizontal',
                                    align: 'center',
                                    verticalAlign: 'bottom'
                                }
                            }
                        }]
                    }

                },
                function () {
                    this.series[0].hide();
                    this.series[0].show();
                }
            );

        }

        // Function to create the table
        function createTable(data) {

            const tableContainer = document.getElementById('rice_area');
            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // Create table header
            const headerRow = document.createElement('tr');
            const adminLevelHeader = document.createElement('th');
            adminLevelHeader.textContent = data.admin_level;
            headerRow.appendChild(adminLevelHeader);

            data.data[0].values.forEach(entry => {
                const yearHeader = document.createElement('th');
                yearHeader.textContent = entry.year;
                headerRow.appendChild(yearHeader);
            });
            thead.appendChild(headerRow);

            // Create table body
            data.data.forEach(item => {
                const row = document.createElement('tr');
                const adminLevelCell = document.createElement('td');
                adminLevelCell.textContent = item.name;
                row.appendChild(adminLevelCell);

                item.values.forEach(entry => {
                    const valueCell = document.createElement('td');
                    valueCell.textContent = entry.value;
                    row.appendChild(valueCell);
                });

                tbody.appendChild(row);
            });

             // Add a separator row
            const separatorRow = document.createElement('tr');
            const separatorCell = document.createElement('td');
            separatorCell.colSpan = data.data[0].values.length + 1; // Span all columns
            separatorCell.textContent = data.admin_level.toLowerCase().trim() === "dzongkhag" ? '--- Country Sum ---' : '--- Dzongkhag Sum ---'; // Separate label
            separatorRow.appendChild(separatorCell);
            tbody.appendChild(separatorRow);


            // Calculate and add country totals row
            const countryTotalsRow = document.createElement('tr');
            const countryTotalsLabelCell = document.createElement('td');
            countryTotalsLabelCell.textContent = data.active;
            countryTotalsRow.appendChild(countryTotalsLabelCell);

            // Calculate sum of values for each year
            data.data[0].values.forEach((_, index) => {
                const sum = data.data.reduce((total, item) => total + item.values[index].value, 0);
                const valueCell = document.createElement('td');
                valueCell.textContent = sum.toFixed(2); // Format to two decimal places
                countryTotalsRow.appendChild(valueCell);
            });

            tbody.appendChild(countryTotalsRow);


            // Append header and body to table
            table.appendChild(thead);
            table.appendChild(tbody);

            const h4 = document.createElement('h4');

            h4.textContent = "Average rice area by " + data.admin_level;
            tableContainer.appendChild(h4);
            // Append table to container
            tableContainer.appendChild(table);
        }

        function loadGewogs(dzongkhag, which) {
            document.getElementById("gewogOptions").innerHTML = "";
            addFilterBox("gewogOptions", "gewogsFilter")

            addOptions([{
                name: "All Gewogs",
                gewog_id: "-999"
            }, ...(getGewogs(dzongkhag))], "gewogOptions", "gewogsFilter", 'gewog');
            if (which) {
                dzongkhag = which;
            }

            $.ajax({
                url: '/get-gewog-by-dzongkhag-id/' + dzongkhag, // Adjust the URL as per your Django API endpoint
                method: 'GET',
                success: function (data) {
                    // Handle the response data here
                    // Remove previously added features
                    removePreviousFeatures();

// Add features from JSON object to the layer
                    addFeaturesToLayer(data);
                },
                error: function (error) {
                    // Handle errors here
                    console.error('Error loading Gewogs:', error);
                }
            });
        }

        function createSparklineChart(container, data) {
            var units = ['NDVI', 'mm', 'mm', '&deg;C'];
            Highcharts.chart(container, {
                chart: {
                    type: 'line',
                    backgroundColor: null,
                    borderWidth: 0,
                    margin: [2, 0, 2, 0],
                    style: {
                        overflow: 'visible'
                    }
                },
                title: {
                    text: null
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    visible: false,
                    categories: ['2016', '2017', '2018', '2019', '2020', '2021', '2022']
                },
                yAxis: {
                    visible: false
                },
                legend: {
                    enabled: false
                },
                tooltip: {
                    formatter: function () {
                        var pointIndex = this.point.index;
                        var series = this.series.chart.series[this.series.index];
                        var unit = series.userOptions.unit;
                        return '<b>' + Highcharts.dateFormat('%Y', this.x) + '</b><br/>' +
                            Highcharts.numberFormat(this.y, 2) + ' ' + unit;
                    }
                },
                plotOptions: {
                    series: {
                        animation: false,
                        color: 'white'
                    }
                },
                exporting: {
                    enabled: false // Disable exporting for this chart
                },
                series: [data]
            });
        }

        function highlightTableRow(name) {
            // Remove background color from all rows
            const tableRows = document.querySelectorAll('#rice_area tbody tr');
            tableRows.forEach(row => {
                row.style.backgroundColor = '';
            });

            // Find the row with the matching name and add background color
            tableRows.forEach(row => {
                const firstCell = row.querySelector('td:first-child');
                if (firstCell && firstCell.textContent.trim() === name) {
                    row.style.backgroundColor = 'darkcyan';
                }
            });
        }

        function get_formatted_data(data) {
            const formatted_data = [];
            const excluded = ["temperature", "precipitation", "ndvi", "soil_moisture", "paddy_gain", "paddy_loss"]
            for (var dzongkhag_name in data) {
                if (data.hasOwnProperty(dzongkhag_name) && !excluded.includes(dzongkhag_name)) {
                    // Initialize an array to store the values for the current Dzongkhag
                    var dzongkhag_values = [];

                    // Loop through each year's data for the current Dzongkhag
                    for (var year in data[dzongkhag_name]) {
                        if (data[dzongkhag_name].hasOwnProperty(year)) {
                            // Extract the average rice value for the current year
                            var average_rice_value = data[dzongkhag_name][year]['average_rice'];

                            // Push the year and value pair to the dzongkhag_values array
                            dzongkhag_values.push({
                                'year': parseInt(year),
                                'value': average_rice_value.length > 0 ? average_rice_value[0] : null
                            });
                        }
                    }

                    // Push the formatted data for the current Dzongkhag to the formatted_data array
                    formatted_data.push({
                        'name': dzongkhag_name,
                        'values': dzongkhag_values
                    });
                }
            }

            return formatted_data;
        }

        $(function () {
                // Initial call to set aspect ratio on page load
                updateAspectRatio();

                buildChart('paddy_gain', 'Paddy Gain/Loss', 'Bumthang Dzongkhag 2016: 10.96 acres', 'column', 2017, 'acres', 'Range: 2016 to 2022', [{
                    name: 'Paddy Gain',
                    data: full_data["paddy_gain"].map(function (data) {
                            return data.val;
                        })
                }, {
                    name: 'Paddy Loss',
                    data: full_data["paddy_loss"].map(function (data) {
                            return data.val;
                        })
                }], ['rgb(90,254,44)', 'rgb(255,38,0)']);

                var seriesData = [
                    {
                        name: 'NDVI',
                        data: full_data["ndvi"].map(function (data) {
                            return data.val;
                        }),
                        unit: 'NDVI'
                    },
                    {
                        name: 'Precipitation',
                        data: full_data["precipitation"].map(function (data) {
                            return data.val;
                        }),
                        unit: 'mm'
                    },
                    {
                        name: 'Soil Moisture',
                        data: full_data["soil_moisture"].map(function (data) {
                            return data.val;
                        }),
                        unit: 'mm'
                    },
                    {
                        name: 'Temperature',
                        data: full_data["temperature"].map(function (data) {
                            return data.val;
                        }),
                        unit: '&deg;C'
                    }
                ];

                var tableBody = $('#sparklineTable tbody');

                seriesData.forEach(function (series) {
                    var row = $('<tr></tr>');
                    var parameterCell = $('<td></td>').text(series.name);
                    var sparklineCell = $('<td></td>').addClass('sparkline-chart');

                    row.append(parameterCell);
                    row.append(sparklineCell);
                    tableBody.append(row);

                    createSparklineChart(sparklineCell[0], series);
                });

                buildPie();

                map = L.map('map', {
                    zoomControl: true, fullscreenControl: true, center: [27.41016657183734, 90.44523404431789], zoom: 8
                });

                map.createPane('left');
                map.createPane('right');
                map.zoomControl.setPosition('topright');

                // Add the Search Control to the map
                const search = new GeoSearch.GeoSearchControl({
                    id:"search_ctl",
                    provider: new GeoSearch.OpenStreetMapProvider(), showMarker: false, // optional: true|false  - default true
                    showPopup: false, position: 'topright', autoClose: true,
                });
                map.addControl(search);
                var dzongkhagData = {{ dzongkhags|safe }}; // Assuming dzongkhags is a list of Dzongkhag data

                // Create an empty array to hold the GeoJSON features
                var dzongkhagFeatures = [];

                // Iterate over the Dzongkhag data
                dzongkhagData.forEach(function (dzongkhag) {
                    // Create a GeoJSON feature object
                    var feature = {
                        "type": "Feature",
                        "properties": {
                            "id": dzongkhag.id,
                            "name": dzongkhag.name
                        },
                        "geometry": dzongkhag.geometry
                    };

                    // Add the feature to the array
                    dzongkhagFeatures.push(feature);
                });
                gewog_features = L.geoJSON(null, {
                    id: 'gewog_features',
                    // Add style function to customize the appearance of features
                    style: function (feature) {
                        return {
                            fillColor: 'transparent', // Set fill color to 'none' to remove fill
                            color: '#0a57c9', // Set border color (stroke color)
                            weight: 4 // Set border width (stroke width)
                        };
                    },
                    onEachFeature: function (feature, layer) {

                        // Add a click event listener to load Gewogs when clicking the layer
                        layer.on('click', function (e) {

                            var bounds = layer.getBounds();


                            // Fit the map view to the bounds of the clicked feature
                            {#map.fitBounds(bounds);#}
                            // Call the loadGewogs function passing the ID from the clicked feature
                            selectGewogOption(feature.properties.name, feature.properties.id);
                            
                            
                            
                            if (feature.properties.id != "-999") {
                                L.DomEvent.stopPropagation(e);
                                L.DomEvent.preventDefault(e);
                                L.DomEvent.stop(e);
                                L.DomEvent.stopPropagation(e.originalEvent);
                                L.DomEvent.preventDefault(e.originalEvent);
                                L.DomEvent.stop(e.originalEvent);
                            }
                        });
                    }
                }).addTo(map);

                // Create a GeoJSON layer with hover and click events
                dzongkhagLayer = L.geoJSON(dzongkhagFeatures, {
                    id: "dzongkhagLayer",
                    style: function (feature) {
                        return {
                            fillColor: 'transparent', // Set fill color to 'none' to remove fill
                            color: '#ffffff', // Set border color (stroke color)
                            weight: 2 // Set border width (stroke width)
                        };
                    },
                    onEachFeature: function (feature, layer) {

                        // Add a click event listener to load Gewogs when clicking the layer
                        layer.on('click', function (e) {
                            var bounds = layer.getBounds();

                            map.fitBounds(bounds);

                            var sidebarWidth = document.getElementById('sidebar-content').offsetWidth;
                            var mapCenter = map.getCenter();
                            var newCenter = map.unproject(map.project(mapCenter).subtract(L.point(sidebarWidth / 2, 0)));


                            // Fit the map view to the bounds of the clicked feature


                            // Call the loadGewogs function passing the ID from the clicked feature
                            selectOption(feature.properties.name, feature.properties.id);

                            map.setView(newCenter);

                        });
                    }
                }).addTo(map);

// Fit the map to the extent of the GeoJSON layer
                map.fitBounds(dzongkhagLayer.getBounds());
                $(".leaflet-bar-timecontrol").css("margin-left", "50px");
                $('.leaflet-bar-timecontrol').css('display', 'inline');
                window.dispatchEvent(new Event('resize'));


                {#var formatted_data = [];#}

// Loop through each Dzongkhag in the full_data object


                // Call the function with your JSON data
                createTable({
                    "active": "Bhutan",
                    "admin_level": "Dzongkhag",
                    "data": get_formatted_data(full_data)
                });
                setupMenu();
                makeSlider();
                add_paddy_wms(2016);
                baseLayers = getCommonBaseLayers(map); // use baselayers.js to add, remove, or edit
                sidebar = L.control.sidebar("sidebar").addTo(map);
                for (let key of Object.keys(baseLayers)) {
                    const map_thumb = $("<div>");
                    map_thumb.addClass("map-thumb");
                    map_thumb.attr("datavalue", key);
                    map_thumb.on("click", handleBaseMapSwitch);

                    const thumb_cap = $("<div>");
                    thumb_cap.addClass("caption-text");

                    const thumb_text = $("<h2>");
                    thumb_text.text(baseLayers[key].options.displayName);

                    thumb_text.appendTo(thumb_cap);
                    const img = $("<img src='" +
                        static_url + "" +
                        baseLayers[key].options.thumb +
                        "' alt='" +
                        baseLayers[key].options.displayName + "'>", {
                        title: baseLayers[key].options.displayName,
                        datavalue: key,
                        click: 'handleBaseMapSwitch($(this)[0].getAttribute("datavalue"))'
                    });
                    img.addClass("basemapbtn");
                    img.appendTo(map_thumb);
                    thumb_cap.appendTo(map_thumb);
                    map_thumb.appendTo("#basemap");
                }

                sidebar.open('layers');

                client_layers.forEach(createLayer);
                sortableLayerSetup();
                adjustLayerIndex();
                $('.yearpicker').off();
                setupYearPicker();
                setupMonthlyPicker();


            }
        )
        //End ready

        // Function to remove previously added features from the layer
        function removePreviousFeatures() {
            gewog_features.clearLayers();
        }

        // Function to add features from JSON object to the layer
        function addFeaturesToLayer(data) {
            // Iterate over each gewog in the JSON object
            data.gewogs.forEach(function (gewog) {
                // Create a GeoJSON feature for each gewog
                var feature = {
                    "type": "Feature",
                    "properties": {
                        "id": gewog.id,
                        "name": gewog.name
                    },
                    "geometry": gewog.geometry
                };

                // Add the feature to the layer
                gewog_features.addData(feature);
            });
        }


        // Resize sparkline charts when window is resized
        $(window).resize(function () {
            $('#sparklineTable .sparkline-chart').each(function () {
                var chart = $(this).highcharts();
                if (chart) {
                    chart.setSize(this.offsetWidth, 50);
                }
            });
        });

        var the_input;

        function positionDatepicker(inputField) {
            the_input = inputField;
            var inputOffset = inputField.offset();
            var sidebarContentOffset = $('.sidebar-content').offset();
            var inputHeight = inputField.outerHeight();
            var datePicker = $(inputField.siblings()[2]);
            var datePickerHeight = datePicker.outerHeight();
            var windowHeight = $(window).height();
            var sidebarContentHeight = $('#sidebar').height();

            the_picker = datePicker;

            // Check if the datepicker would be partially or fully outside the sidebar content
            if (inputOffset.top + inputHeight + datePickerHeight > sidebarContentOffset.top + sidebarContentHeight) {
                datePicker.css('top', datePickerHeight * -1 + "px");
            }
        }

        function openPicker(which) {
            $("#" + which.id).datepicker('show');
        }

        /**
         * openLegend
         * Opens the legend for the selected layer
         * @param {string} which - Name of layer to open legend for
         */
        function openLegend(which) {
            close_dialog();
            const dialog = $("#dialog");
            let id = which.replace("TimeLayer", "") + "ens";
            const active_layer = getLayer(which) || getLayer($("[id^=" + id + "]")[0].id);
            const src =
                active_layer.url +
                "&REQUEST=GetLegendGraphic&LAYER=" +
                active_layer.layers +
                "&colorscalerange=" +
                active_layer.colorrange +
                "&PALETTE=" +
                active_layer.styles.substr(active_layer.styles.indexOf("/") + 1);
            const style = "text-align:center;";
            dialog.html(
                '<p style="' + style + '"><img src="' + src + '" alt="legend"></p>'
            );
            dialog.dialog({
                title: active_layer.title,
                resizable: {handles: "se"},
                width: 169,
                height: 322,
                position: {
                    my: "center",
                    at: "center",
                    of: window
                }
            });
            $(".ui-dialog-title").attr("title", active_layer.title);
        }

        /**
         * close_dialog
         * Closes the dialog if it is open
         */
        function close_dialog() {
            const dialog = $("#dialog");
            if (dialog.dialog()) {
                dialog.dialog("close");
            }
        }

        /**
         * getLayer
         * Helper function to get a layer out of globalLayerArray
         * @param {string} which - name of layer requesting
         * @returns layer json object
         */
        function getLayer(which) {
            return client_layers.find(
                (item) => item.id === which.replace("TimeLayer", "")
            );
        }

        /**
         * handleBaseMapSwitch
         * Switches the basemap to the user selected map.
         * @param {string} which - The Key of the basemap
         */
        function handleBaseMapSwitch(which) {
            if (which.currentTarget) {
                which = which.currentTarget.getAttribute('datavalue');
            }
            map.removeLayer(baseLayers[active_basemap]);
            active_basemap = which;
            baseLayers[active_basemap].addTo(map);
            changeDzongkhagLayerStyle(which);
        }

        function validateYear(input) {
            var year = parseInt(input.value);
            if (isNaN(year)) {
                alert("Please enter a valid year.");
                input.value = ""; // Clear the input field
            } else if (year < 2016 || year > 2022) {
                alert("Please enter a valid 4-digit year.");
                input.value = ""; // Clear the input field
            }
        }

        // Function to find the layer with the specified ID
        function findLayerById(id) {
            var foundLayer = null;
            map.eachLayer(function (layer) {
                if (layer.options && layer.options.id === id) {
                    foundLayer = layer;
                }
            });
            return foundLayer;
        }

        function changeDzongkhagLayerStyle(basemapName) {

            {#dzongkhagLayer = findLayerById("dzongkhagLayer");#}
            // Check the name of the basemap and set the fill color of dzongkhagLayer accordingly
            const white = ["Gsatellite", "Satellite"]
            const green = ["OSM", "Topo", "Terrain", "NatGeo"]
            dzongkhagLayer.eachLayer(function (layer) {
                // Define default style properties
                var style = {
                    fillColor: 'transparent', // Default fill color
                    color: '#0D3309', // Default border color
                    weight: 2 // Default border width
                };

                // Update style based on the basemapName
                if (green.includes(basemapName)) {
                    style.color = '#0D3309'; // Change fill color to green
                } else if (white.includes(basemapName)) {
                    style.color = '#ffffff'; // Change fill color to white
                }

                layer.setStyle(style);
            });


        }

        /**
         * layer_filter
         * Helper function to filter layers by user input
         * in the text field layer_filter
         */
        function layer_filter() {
            const input = document.getElementById('layer_filter');
            const filter = input.value.toUpperCase();
            const layer_list = document.getElementById("layer-list");
            const layers = layer_list.getElementsByTagName('li');

            for (let i = 0; i < layers.length; i++) {
                const label = layers[i].getElementsByClassName("cblabel")[0];
                if (label) {
                    const txtValue = label.textContent || label.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        layers[i].style.display = "";
                    } else {
                        layers[i].style.display = "none";
                    }
                }
            }
        }

        function showNextElement(element) {
            // Find the next sibling element
            var nextElement = element.nextElementSibling;

            // Remove the "hide" class from the next element
            if (nextElement) {
                nextElement.classList.remove("hide");
            }
        }

        function setupMonthlyPicker() {
            $('.monthlypicker').each(function () {
                var container = $(this).parent();


                $(this).datepicker({
                    format: "mm-yyyy", // Set the format to display month and year
                    viewMode: "months", // Display the datepicker in month view mode
                    minViewMode: "months", // Set the minimum view mode to months
                    autoclose: true,
                    container: container,
                    orientation: 'auto',
                    startDate: "01-2016", // Set the start date to January 2016
                    endDate: "12-2022", // Set the end date to December 2022
                    defaultViewDate: {year: 2016, month: 0}
                }).on('show', function (event) {
                    positionDatepicker($(this));
                });
            });

        }

        function setupYearPicker() {

            $('.yearpicker').each(function () {
                var container = $(this).parent();

                $(this).datepicker({
                    format: "yyyy",
                    viewMode: "years",
                    startView: "years",
                    minViewMode: "years",
                    maxViewMode: "years",
                    autoclose: true,
                    container: container,
                    orientation: 'auto',
                    startDate: new Date(2016, 0, 1)
                }).on('show', function (event) {


                    var currentYear = $(this).datepicker('getDate').getFullYear();

                    var startYear = 2016;
                    var endYear = 2022;
                    var numYears = endYear - startYear + 1;


                    // Clear out all existing years
                    $('.datepicker-years .datepicker-switch').text(startYear);


                    // Generate and append years
                    var yearsHtml = '';
                    for (var i = 0; i < numYears; i++) {
                        var year = startYear + i;
                        yearsHtml += '<span class="year' + (year === currentYear ? ' active' : '') + '">' + year + '</span>';
                    }
                    $('.datepicker-years tbody').html('<tr><td colspan="7">' + yearsHtml + '</td></tr>');

                    positionDatepicker($(this));

                });

            });
        }

        function setupYearPickerold() {
            $('.yearpicker').yearpicker({

                // Initial Year
                year: 2016,

                // Start Year
                startYear: 2016,

                // End Year
                endYear: 2022,

                // Element tag
                itemTag: 'li',

                // Default CSS classes
                selectedClass: 'selected',
                disabledClass: 'disabled',
                hideClass: 'hide',

                // Custom template
                template: `<div class="yearpicker-container">
              <div class="yearpicker-header">
                  <div class="yearpicker-prev" data-view="yearpicker-prev">&lsaquo;</div>
                  <div class="yearpicker-current" data-view="yearpicker-current">SelectedYear</div>
                  <div class="yearpicker-next" data-view="yearpicker-next">&rsaquo;</div>
              </div>
              <div class="yearpicker-body">
                  <ul class="yearpicker-year" data-view="years">
                  </ul>
              </div>
          </div>
  `,

            });
        }

        function makeSlider() {
            // Initialize noUiSlider
            var yearSlider = document.getElementById('yearSlider');
            noUiSlider.create(yearSlider, {
                start: [2016], // Initial value
                step: 1,
                range: {
                    'min': [2016],
                    'max': [2022]
                },
                pips: {
                    mode: 'steps',
                    density: -1
                }
            });

// Listen for change event
            yearSlider.noUiSlider.on('update', function (values, handle) {
                // set pie chart data for selected year
                setPieYear(parseInt(values[handle]));

            });
        }

        function setPieYear(which) {

            var pieData = [{
                "year": 2016,
                data: [
                    {
                        name: 'District 1',
                        y: 4100.123
                    },
                    {
                        name: 'District 2',
                        y: 3240.2
                    },
                    {
                        name: 'District 3',
                        y: 2345.12
                    },
                    {
                        name: 'District 4',
                        y: 1345.0
                    },
                    {
                        name: 'District 5',
                        y: 500.25
                    },
                    {
                        name: 'District 6',
                        y: 1.68
                    }
                ]
            },
                {
                    "year": 2017,
                    data: [
                        {
                            name: 'District 1',
                            y: 400.123
                        },
                        {
                            name: 'District 2',
                            y: 1240.2
                        },
                        {
                            name: 'District 3',
                            y: 4345.12
                        },
                        {
                            name: 'District 4',
                            y: 1345.0
                        },
                        {
                            name: 'District 5',
                            y: 500.25
                        },
                        {
                            name: 'District 6',
                            y: 1.68
                        }
                    ]
                },
                {
                    "year": 2018,
                    data: [
                        {
                            name: 'District 1',
                            y: 4400.123
                        },
                        {
                            name: 'District 2',
                            y: 3440.2
                        },
                        {
                            name: 'District 3',
                            y: 2445.12
                        },
                        {
                            name: 'District 4',
                            y: 1445.0
                        },
                        {
                            name: 'District 5',
                            y: 5400.25
                        },
                        {
                            name: 'District 6',
                            y: 14.68
                        }
                    ]
                },
                {
                    "year": 2019,
                    data: [
                        {
                            name: 'District 1',
                            y: 2300.123
                        },
                        {
                            name: 'District 2',
                            y: 3740.2
                        },
                        {
                            name: 'District 3',
                            y: 2945.12
                        },
                        {
                            name: 'District 4',
                            y: 1945.0
                        },
                        {
                            name: 'District 5',
                            y: 590.25
                        },
                        {
                            name: 'District 6',
                            y: 19.68
                        }
                    ]
                },
                {
                    "year": 2020,
                    data: [
                        {
                            name: 'District 1',
                            y: 3100.123
                        },
                        {
                            name: 'District 2',
                            y: 3240.2
                        },
                        {
                            name: 'District 3',
                            y: 2345.12
                        },
                        {
                            name: 'District 4',
                            y: 2345.0
                        },
                        {
                            name: 'District 5',
                            y: 2300.25
                        },
                        {
                            name: 'District 6',
                            y: 122.68
                        }
                    ]
                },
                {
                    "year": 2021,
                    data: [
                        {
                            name: 'District 1',
                            y: 3100.123
                        },
                        {
                            name: 'District 2',
                            y: 1240.2
                        },
                        {
                            name: 'District 3',
                            y: 3345.12
                        },
                        {
                            name: 'District 4',
                            y: 2345.0
                        },
                        {
                            name: 'District 5',
                            y: 1500.25
                        },
                        {
                            name: 'District 6',
                            y: 133.68
                        }
                    ]
                },
                {
                    "year": 2022,
                    data: [
                        {
                            name: 'District 1',
                            y: 1100.123
                        },
                        {
                            name: 'District 2',
                            y: 3240.2
                        },
                        {
                            name: 'District 3',
                            y: 1345.12
                        },
                        {
                            name: 'District 4',
                            y: 3345.0
                        },
                        {
                            name: 'District 5',
                            y: 50.25
                        },
                        {
                            name: 'District 6',
                            y: 231.68
                        }
                    ]
                }];

            var newData = null;

            // Loop through pieData array to find the object with matching year
            for (var i = 0; i < pieData.length; i++) {
                if (pieData[i].year === which) {
                    newData = pieData[i].data;
                    break; // Stop loop when matching year is found
                }
            }

            piechart.series[0].setData(newData);

        }

        window.addEventListener('resize', updateAspectRatio);

        function updateAspectRatio() {
            var aspectRatio = 9 / 16; // 9:16 aspect ratio
            var containers = document.querySelectorAll('.aspect-ratio-container');
            containers.forEach(function (container) {
                var containerWidth = container.offsetWidth;
                var containerHeight = containerWidth * aspectRatio;
                container.style.height = containerHeight + 'px';
            });
        }

        const levels = {
            country: ["Bhutan"],
            dzongkhag: [
                "All Dzongkhags",
                "Bumthang",
                "Chukha",
                "Dagana",
                "Gasa",
                "Haa",
                "Lhuentse",
                "Mongar",
                "Paro",
                "Pemagatshel",
                "Punakha",
                "Samdrup Jongkhar",
                "Samtse",
                "Sarpang",
                "Thimphu",
                "Trashigang",
                "Trashiyangtse",
                "Trongsa",
                "Tsirang",
                "Wangdue Phodrang",
                "Zhemgang"
            ], // Replace with actual Dzongkhags of Bhutan
            gewog: ["walla", "whalla", "bing", "bang"], // Replace with actual Gewogs of Bhutan
        };

        let selectedValue = "Bhutan"; // Variable to store selected value

        function handleChange() {
            selectedValue = document.getElementById("levelSelect").value;
            const dropdownContainer = document.getElementById("dropdownContainer");

            if (selectedValue === "country") {
                dropdownContainer.innerHTML = `<input type="text" style="width:1px; visibility: hidden;">
                                                <select id="levelDropdown"><option>Bhutan</option></select>`; // Clear dropdown
            } else {
                const options = levels[selectedValue].map(option => `<option>${option}</option>`).join('');
                dropdownContainer.innerHTML = `<input type="text" id="filterInput" onkeyup="filterDropdown()" onfocus="openDropdown()" placeholder="Search...">
                                                  <select id="levelDropdown" onchange="updateFilter();" onclick="updateFilter();">${options}</select> `;

            }
        }

        function updateFilter() {
            const dropdown = document.getElementById("levelDropdown");
            const selectedOption = dropdown.options[dropdown.selectedIndex].textContent;
            document.getElementById("filterInput").value = selectedOption;
            closeDropdown();
        }

        function filterDropdown() {
            const input = document.getElementById("filterInput").value.toUpperCase();
            const dropdown = document.getElementById("levelDropdown");
            const options = dropdown.getElementsByTagName("option");
            let closestMatch = "";

            for (let i = 0; i < options.length; i++) {
                const text = options[i].textContent.toUpperCase();
                if (text.indexOf(input) > -1) {
                    options[i].style.display = "";
                    if (!closestMatch) {
                        closestMatch = options[i].textContent;
                    }
                } else {
                    options[i].style.display = "none";
                }
            }

            // Update selected value to the closest match
            if (closestMatch && !options.namedItem(selectedValue)) {
                dropdown.value = closestMatch;
            }
        }

        function openDropdown() {
            const dropdown = document.getElementById("levelDropdown");
            dropdown.size = dropdown.options.length;
            dropdown.style.position = "absolute"; // Position dropdown absolutely
        }

        function closeDropdown() {
            const dropdown = document.getElementById("levelDropdown");
            dropdown.size = 1;
            dropdown.style.position = ""; // Reset position
        }

        function filterOptions(optionsID, filterID) {

            var input, filter, ul, li, a, i;
            input = document.getElementById(filterID);
            filter = input.value.toUpperCase();
            ul = document.getElementById(optionsID);
            li = ul.getElementsByTagName("li");
            for (i = 1; i < li.length; i++) {
                a = li[i].getElementsByTagName("a")[0];
                if (a.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        }

        function addFilterBox(optionsID, filterID) {
            var filterInput = document.createElement("input");
            filterInput.setAttribute("class", "form-control");
            filterInput.setAttribute("type", "text");
            filterInput.setAttribute("id", filterID);
            filterInput.setAttribute("onkeyup", "filterOptions('" + optionsID + "','" + filterID + "')");
            filterInput.setAttribute("placeholder", "Search...");
            var filterLi = document.createElement("li");
            filterLi.appendChild(filterInput);
            document.getElementById(optionsID).appendChild(filterLi);
        }

        function getGewogs(dzongkha) {
            let country = $("#selectedCountry").text();
            if (boundary["Countries"][country]["dzongkhags"][dzongkha]) {
                return boundary["Countries"][country]["dzongkhags"][dzongkha]["gewogs"];
            } else {
                return [];
            }
        }

        function loadDzongkhags(country) {
            // Clear the previous options
            document.getElementById("dzongkhagOptions").innerHTML = "";
            addFilterBox("dzongkhagOptions", "dzongkhagFilter")

            const dzongkhags = getDzongkhags(country);
            const dzongkhas_list = []
            for (const key in dzongkhags) {

                dzongkhas_list.push(dzongkhags[key]);

            }


            addOptions([{
                name: "All Dzongkhags",
                dzongkhag_id: "-999"
            }, ...dzongkhas_list], "dzongkhagOptions", "dzongkhagFilter");
        }

        function getDzongkhags(country) {
            if (boundary["Countries"][country]) {
                return boundary["Countries"][country]["dzongkhags"];
            } else {
                return [];
            }
        }

        function addOptions(options, dropdownID, filterID, isGewog) {
            const gewog = isGewog ? "Gewog" : "";
            var ul = document.getElementById(dropdownID);


            options.forEach(function (option) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.setAttribute("href", "#");
                a.setAttribute("class", "dropdown-item");
                if (isGewog) {
                    a.setAttribute("onclick", "select" + gewog + "Option('" + option.name + "', '" + option.gewog_id + "')");
                } else {
                    a.setAttribute("onclick", "selectOption('" + option.name + "', '" + option.dzongkhag_id + "')");
                }
                a.textContent = option.name;
                li.appendChild(a);
                ul.appendChild(li);
            });
        }

        function selectGewogOption(name, id) {
            // Update the label of the second dropdown
            document.getElementById("selectGewog").innerHTML = name;
            $("#gewogsFilter").val('');
            filterOptions('gewogOptions', 'gewogsFilter');
            if (id == "-999") {
                gewog_features.clearLayers();
                // ********   selectOption()
                var buttonText = document.getElementById('selectDzongkhag').innerText.trim();

                // Step 2: Iterate through the list items inside the dropdown menu
                var listItems = document.querySelectorAll('#dzongkhagOptions .dropdown-item');
                listItems.forEach(function (listItem) {
                    // Step 3: Extract the text of the <a> tag
                    var linkText = listItem.innerText.trim();

                    // Step 4: If the text matches the text of the button, trigger a click event on that <a> tag
                    if (linkText === buttonText) {
                        listItem.click();
                        // If you want to stop after finding the first match, you can break the loop here
                        // return;
                    }
                });
            } else {
                highlightTableRow(name);
                $.ajax({
                    url: '/get-gewog-data/' + id, // Adjust the URL as per your Django API endpoint
                    method: 'GET',
                    success: function (gewog_data) {
                        
                        // Clear all graphs and load with the new data
                        buildChart('paddy_gain', 'Paddy Gain/Loss', 'something different', 'column', 2017, 'acres', 'Range: 2016 to 2022', [{
                            name: 'Paddy Gain',
                            data: gewog_data["paddy_gain"].map(function (data) {
                                return data.val;
                            })
                        }, {
                            name: 'Paddy Loss',
                            data: gewog_data["paddy_loss"].map(function (data) {
                                return data.val;
                            })
                        }], ['rgb(90,254,44)', 'rgb(255,38,0)']);

                        
                        
                    },
                    error: function (error) {
                        // Handle errors here
                        console.error('Error getting new data:', error);
                    }
                });
                
                
                gewog_features.eachLayer(function (layer) {
                    // Check if the layer's feature id matches the provided featureId
                    if (layer.feature.properties.id === id) {
                        // Fit the map bounds to the geometry of the matched layer
                        map.fitBounds(layer.getBounds());
                    }
                });
            }

            console.log("Ajax to get and update values for gewog");
        }

        function selectOption(option, dzongkhagID) {

            // Update the label of the second dropdown
            document.getElementById("selectDzongkhag").innerHTML = option;
            if (option.toLowerCase() === "all dzongkhags") {
                $("#gewoglist").hide();
                 createTable({
                     "active": "Bhutan",
                    "admin_level": "Dzongkhag",
                    "data": get_formatted_data(full_data)
                });
                gewog_features.clearLayers();
                buildChart('paddy_gain', 'Paddy Gain/Loss', 'Bumthang Dzongkhag 2016: 10.96 acres', 'column', 2017, 'acres', 'Range: 2016 to 2022', [{
                    name: 'Paddy Gain',
                    data: full_data["paddy_gain"].map(function (data) {
                            return data.val;
                        })
                }, {
                    name: 'Paddy Loss',
                    data: full_data["paddy_loss"].map(function (data) {
                            return data.val;
                        })
                }], ['rgb(90,254,44)', 'rgb(255,38,0)']);
                map.fitBounds(dzongkhagLayer.getBounds());
            } else {
                $.ajax({
                    url: '/get-dzongkhag-data/' + dzongkhagID, // Adjust the URL as per your Django API endpoint
                    method: 'GET',
                    success: function (dzongkhag_data) {

                        const tabledata = {
                            "active": getFeatureByDzongkhagID(dzongkhagID).feature.properties.name,
                            "admin_level": "Gewog",
                            "data": get_formatted_data(dzongkhag_data)
                        }
                        
                         buildChart('paddy_gain', 'Paddy Gain/Loss', 'something different', 'column', 2017, 'acres', 'Range: 2016 to 2022', [{
                            name: 'Paddy Gain',
                            data: dzongkhag_data["paddy_gain"].map(function (data) {
                                return data.val;
                            })
                        }, {
                            name: 'Paddy Loss',
                            data: dzongkhag_data["paddy_loss"].map(function (data) {
                                return data.val;
                            })
                        }], ['rgb(90,254,44)', 'rgb(255,38,0)']);

                        createTable(tabledata);
                        // Clear all graphs and load with the new data
                    },
                    error: function (error) {
                        // Handle errors here
                        console.error('Error getting new data:', error);
                    }
                });


                loadGewogs(option, dzongkhagID);
                document.getElementById("selectGewog").innerHTML = "All Gewogs";
                $("#gewoglist").show();

                let feature = getFeatureByDzongkhagID(dzongkhagID);

                // Fit map bounds to the feature's geometry
                if (feature) {
                    map.fitBounds(feature.getBounds());
                }
            }
            $("#dzongkhagFilter").val('');
            filterOptions('dzongkhagOptions', 'dzongkhagFilter');
        }

        function getFeatureByDzongkhagID(dzongkhagID) {
            // Iterate through the GeoJSON layer's features to find the one with the matching dzongkhag ID
            let feature = null;
            dzongkhagLayer.eachLayer(function (layer) {
                if (layer.feature.properties.id === dzongkhagID) {
                    feature = layer;
                }
            });
            return feature;
        }

        function setupMenu() {
            // Get the button element
            var selectedCountryBtn = document.getElementById("selectedCountry");
            // Get the ul element
            var countryList = document.getElementById("countryList");

            // Check the number of countries
            var countryCount = Object.keys(boundary["Countries"]).length;

            // If there's only one country, set the button text to that country's name
            if (countryCount === 1) {
                var countryName = Object.keys(boundary["Countries"])[0];
                selectedCountryBtn.textContent = countryName;
                $("#selectedCountry").removeClass("dropdown-toggle");
                $("#selectedCountry").removeAttr("data-bs-toggle");
                loadDzongkhags(countryName);
                selectedCountryBtn.addEventListener("click", function() {
                    selectOption("All Dzongkhags");
                });
            } else {
                // If there are multiple countries, set the button text to "Select Country"
                selectedCountryBtn.textContent = "Select Country";

                // Add a list of countries sorted in alphabetical order
                var countries = Object.keys(boundary["Countries"]).sort();
                countries.forEach(function (country) {
                    var li = document.createElement("li");
                    var a = document.createElement("a");
                    a.setAttribute("href", "#");
                    a.setAttribute("class", "dropdown-item");
                    a.textContent = country;
                    // Add click event listener to load dzongkhags for the selected country
                    a.addEventListener("click", function () {
                        loadDzongkhags(country);
                    });
                    li.appendChild(a);
                    countryList.appendChild(li);
                });
                $("#selectedCountry").addClass("dropdown-toggle");
                $("#selectedCountry").attr("data-bs-toggle", "dropdown");
                $(countryList).removeClass("display");
            }
        }

        let paddy_layer;
        let compare_control;

        function add_paddy_wms(year) {
            if (paddy_layer) {
                map.removeLayer(paddy_layer);
            }
            /*            paddy_layer = L.tileLayer.wms("https://thredds.servirglobal.net/thredds/wms/cropmonitor/bhutan/paddy/paddy-area." + year + "0101T000000Z.bhutan.30m.yearly.nc4?service=WMS&version=1.3.0&crs=EPSG%3A3857", {
                            layers: "paddy",
                            format: "image/png",
                            transparent: true,
                            colorscalerange: '.5,1',
                            abovemaxcolor: "transparent",
                            belowmincolor: "transparent",
                            numcolorbands: 100,
                            styles: 'boxfill/paddy',
                            tileSize: 256,
                            version: "1.3.0"
                        });
                        */
            {#map.addLayer(paddy_layer);#}
        }

        function testCompare() {

            paddy_layer16 = L.tileLayer.wms("https://thredds.servirglobal.net/thredds/wms/cropmonitor/bhutan/paddy/paddy-area.20160101T000000Z.bhutan.30m.yearly.nc4?service=WMS&version=1.3.0&crs=EPSG%3A3857", {
                layers: "paddy",
                format: "image/png",
                transparent: true,
                colorscalerange: '.5,1',
                abovemaxcolor: "transparent",
                belowmincolor: "transparent",
                numcolorbands: 100,
                styles: 'boxfill/paddy',
                tileSize: 256,
                version: "1.3.0",
                pane: "left"
            });
            map.addLayer(paddy_layer16);

            paddy_layer16_compare = L.tileLayer.wms("https://thredds.servirglobal.net/thredds/wms/cropmonitor/bhutan/paddy/paddy-area.20160101T000000Z.bhutan.30m.yearly.nc4?service=WMS&version=1.3.0&crs=EPSG%3A3857", {
                layers: "paddy",
                format: "image/png",
                transparent: true,
                colorscalerange: '.5,1',
                abovemaxcolor: "transparent",
                belowmincolor: "transparent",
                numcolorbands: 100,
                styles: 'boxfill/paddy_compare',
                tileSize: 256,
                version: "1.3.0",
                pane: "right"
            });
            map.addLayer(paddy_layer16_compare);

            paddy_layer20 = L.tileLayer.wms("https://thredds.servirglobal.net/thredds/wms/cropmonitor/bhutan/paddy/paddy-area.20200101T000000Z.bhutan.30m.yearly.nc4?service=WMS&version=1.3.0&crs=EPSG%3A3857", {
                layers: "paddy",
                format: "image/png",
                transparent: true,
                colorscalerange: '.5,1',
                abovemaxcolor: "transparent",
                belowmincolor: "transparent",
                numcolorbands: 100,
                styles: 'boxfill/paddy',
                tileSize: 256,
                version: "1.3.0",
                pane: "right"
            });
            map.addLayer(paddy_layer20);

            paddy_layer20_compare = L.tileLayer.wms("https://thredds.servirglobal.net/thredds/wms/cropmonitor/bhutan/paddy/paddy-area.20200101T000000Z.bhutan.30m.yearly.nc4?service=WMS&version=1.3.0&crs=EPSG%3A3857", {
                layers: "paddy",
                format: "image/png",
                transparent: true,
                colorscalerange: '.5,1',
                abovemaxcolor: "transparent",
                belowmincolor: "transparent",
                numcolorbands: 100,
                styles: 'boxfill/paddy_compare',
                tileSize: 256,
                version: "1.3.0",
                pane: "left"
            });
            map.addLayer(paddy_layer20_compare);
            compare_control = L.control.sideBySide([paddy_layer16, paddy_layer20_compare], [paddy_layer20, paddy_layer16_compare]).addTo(map);

            document.getElementsByClassName('leaflet-sbs-range')[0].setAttribute('min', '-0.01');
            document.getElementsByClassName('leaflet-sbs-range')[0].setAttribute('max', '1.01');

            document.getElementsByClassName('leaflet-sbs-range')[0].setAttribute('onmouseover', 'map.dragging.disable()')
            document.getElementsByClassName('leaflet-sbs-range')[0].setAttribute('onmouseout', 'map.dragging.enable()')
        }

        function toggleLayer(which) {
            // Get date from the button and set b4 adding, else the layer and date will be out of sync
            const date_control = $("#" + which + "_date");
            if (map.hasLayer(overlayMaps[which])) {
                map.removeLayer(overlayMaps[which]);

                date_control.addClass("disabled");
                date_control.prop("disabled", true);
            } else {
                map.addLayer(overlayMaps[which]);
                date_control.removeClass("disabled");
                date_control.prop("disabled", false);
            }
        }

        function createLayer(item) {
            overlayMaps[item.id] = L.tileLayer.wms(item.url + "&crs=EPSG%3A3857", {
                layers: item.layers,
                format: "image/png",
                transparent: true,
                colorscalerange: item.colorrange,
                abovemaxcolor: item.overrange,
                belowmincolor: item.belowrange,
                numcolorbands: 100,
                styles: item.styles,
                tileSize: 256,
                version: "1.3.0",
                time: item.default_year + "-01-01T00:00:00.000Z"
            });
            if (item.default_on === "True") {
                toggleLayer(item.id);
            }
        }

        function updateLayer(which) {


            const id = which.id.replace("_date", "");

            var layer = overlayMaps[id];

            // Check if the layer is a WMS layer
            if (layer instanceof L.TileLayer.WMS) {
                // Update the time parameter
                if (which.value.indexOf("-") > 0) {
                    const date_values = which.value.split("-");
                    layer.setParams({time: date_values[1] + "-" + date_values[0] + "-01T00:00:00.000Z"});
                } else {

                    layer.setParams({time: which.value + "-01-01T00:00:00.000Z"});
                }
            }
        }

        function navigateDate(inputId, direction) {
            const input = document.getElementById(inputId);
            const dateValue = input.value;

            // Extract year and month from the date value
            const dateValues = dateValue.split("-");
            const year = parseInt(dateValues[0]);
            const month = parseInt(dateValues[1]) || 1; // Default to 1 if month is not provided

            // Calculate the new date based on the direction
            let newYear = year;
            let newMonth = month;
            if (direction === 'prev') {
                newMonth -= 1;
                if (newMonth < 1) {
                    newMonth = 12;
                    newYear -= 1;
                }
            } else if (direction === 'next') {
                newMonth += 1;
                if (newMonth > 12) {
                    newMonth = 1;
                    newYear += 1;
                }
            }

            // Update the input value with the new date
            input.value = newYear + "-" + (newMonth < 10 ? '0' : '') + newMonth;

            // Trigger the onchange event to update the layer
            updateLayer(input);
        }


        /**
         * sortableLayerSetup
         * Sets up the sortable layers in the layer manager
         * jshint says onChange is not used, but it is used.
         * DO NOT REMOVE onChange
         */
        function sortableLayerSetup() {
            $("ol.layers").sortable({
                group: "simple_with_animation",
                handle: ".rst__moveHandle",
                revert: true,
                pullPlaceholder: true,
                ghostClass: "ui-sortable-placeholder",  // Class name for the drop placeholder
                chosenClass: "sortable-chosen",  // Class name for the chosen item
                dragClass: "sortable-drag",  // Class name for the dragging item
                animation: 150,
                easing: "cubic-bezier(1, 0, 0, 1)",
                change: function (event, ui) {
                    adjustLayerIndex(ui);
                    console.log("change");
                },
                update: function () {
                    adjustLayerIndex();
                    console.log("update");
                },
                filter: ".slider",
                tolerance: "pointer",
            });
        }

        /**
         * adjustLayerIndex
         * adjusts the layer indexes to match the order in the layer manager
         */
        function adjustLayerIndex(ui) {

            let count = 10;
            const ol_layers = $("ol.layers");

            if (ui) {
                const current_index = ui.placeholder.index();
                const dragging_id = ui.helper[0].id;

                // Remove the dragging element temporarily
                const dragging_element = ol_layers.find(`#${dragging_id}`).detach();

                // Insert the dragging element at the correct position
                if (current_index === ol_layers.children().length) {
                    // Insert after the last element
                    ol_layers.append(dragging_element);
                } else {
                    ol_layers.children().eq(current_index).before(dragging_element);
                }
            }
            const li_elements = ol_layers.find("li").toArray().reverse();
            // Re-index the overlayMaps
            li_elements.forEach(function (element) {
                const id = $(element)[0].id.replace("_node", "");
                if (overlayMaps[id]) {
                    overlayMaps[id].setZIndex(count);
                    count++;
                } else {
                    const ensId = id + "ens";
                    $("[id^=" + ensId + "]").each(function () {
                        overlayMaps[$(this)[0].id].setZIndex(count);
                        count++;
                    });
                }
            });
        }

        function set_layer_opacity(layer_id, value) {
            overlayMaps[layer_id].setOpacity(value / 100);

        }


    </script>


{% endblock %}

{% block content %}

    <div class="container-fluid p-0  bg-white">

        <div class="row" style="z-index: 1050; position: relative;">

        </div>
        <div class="row row-sm">
            <div class="col-xl-9 mg-t-20" style="padding-left: 0; z-index: 1006;">
                <div class="col-12 d-flex justify-content-center"
                     style="background-color: #909d6b94; position: absolute; z-index: 1000; width: 99%;">
                    <div class="row row-sm justify-content-center align-items-center"
                         style="z-index: 100; position: relative;">
                        <div class="dropdown col">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                    id="selectedCountry">
                                <span class="caret"></span></button>
                            <ul id="countryList" class="dropdown-menu" aria-labelledby="selectedCountry"></ul>
                        </div>
                        <div class="dropdown col">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                    id="selectDzongkhag">All Dzongkhags
                                <span class="caret"></span></button>
                            <ul class="dropdown-menu" id="dzongkhagOptions">

                            </ul>
                        </div>
                        <div class="dropdown col" id="gewoglist" style="display: none;">
                            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                    id="selectGewog">All Gewogs
                                <span class="caret"></span></button>
                            <ul class="dropdown-menu" id="gewogOptions">

                                <!-- Options will be dynamically populated here -->
                            </ul>
                        </div>
                    </div>
                </div>
                <div id="sidebar" class="sidebar collapsed">
                    <!-- Nav tabs -->
                    <div class="sidebar-tabs">
                        <ul role="tablist">

                            <li>
                                <a href="#layers" role="tab" id="tab-layers" title="Layers">
                                    <i class="fas fa-layer-group"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#basemap" role="tab" id="basemap_link" title="Basemaps"><i
                                        class="fas fa-map"></i></a>
                            </li>
                            <li>
                                <a href="#layer_compare" role="tab" title="Layer Compare"
                                   style="background-image: url({% static 'images/compare.png' %});
                                           background-size: cover;
                                           padding: 12px;">
                                    <i class=""></i>
                                </a>
                            </li>
                        </ul>
                        <ul role="tablist">
                            <li id="tour_box_blink" class="tour_box_blink">
                                <a role="tab" id="tour_link" onclick="open_tour()" title="Open interactive tour"><i
                                        id="tour_icon" class="fas fa-info-circle tour_icon_blink"></i></a>
                            </li>
                        </ul>
                    </div>

                    <!-- Tab panes -->
                    <div id="sidebar-content" class="sidebar-content">
                        <div class="sidebar-pane" id="layer_compare">
                            <div id="chart-builder">
                                <h1 class="sidebar-header">
                                    Compare Layers
                                    <span class="sidebar-close">
                              <i class="fas fa-caret-left"></i>
                            </span>
                                </h1>
                                <h2 class="step-marker">Choose layers to compare</h2>
                            </div>
                        </div>
                        <div class="sidebar-pane" id="chart2">
                            <h1 class="sidebar-header">
                                Statistical Query
                                <span class="sidebar-close">
                              <i class="fas fa-caret-left"></i>
                            </span>
                            </h1>
                            <div id="step1">

                                <form id="query-form2" onsubmit="return false;">
                                    <h2 class="step-marker">Select Data</h2>
                                    <div class="form-group panel-buffer">
                                        <label for="requestTypeSelect">Type</label>
                                        <i
                                                onclick="stats_info('type')"
                                                class="fas fa-question-circle"
                                                aria-hidden="true"
                                                style="float: right;"></i>
                                        <select name="requestTypeSelect" class="form-control" id="requestTypeSelect"
                                                onchange="openDataTypePanel(this)">
                                            <option value="datasets">Dataset</option>
                                            <option value="monthly_analysis">Monthly Rainfall Analysis</option>
                                        </select>
                                    </div>


                                </form>


                            </div>
                        </div>
                        <div class="sidebar-pane" id="layers">
                            <h1 class="sidebar-header">
                                Layers
                                <span class="sidebar-close">
                              <i class="fas fa-caret-left"></i>
                            </span>
                            </h1>
                            <input
                                    type="search"
                                    placeholder="filter layers.."
                                    name="search"
                                    class="form-control searchbox-input"
                                    title="filter layers.."
                                    onsearch="layer_filter()"
                                    onkeyup="layer_filter()"
                                    id="layer_filter"/>
                            <ol class="layers vertical" id="layer-list">
                                {% for layer in data_layers %}
                                    {% if layer.hasVisualization %}
                                        <li id="{{ layer.ui_id }}_node"
                                            style="display: {% if layer.hasVisualization %} block {% else %} none {% endif %}">
                                            <div class="rst__nodeContent" style="left: 44px">
                                                <div style="height: 100%">
                                                    <div class="rst__rowWrapper">
                                                        <div class="rst__row" style="opacity: 1">
                                                            <div class="rst__moveHandle"></div>
                                                            <div class="rst__rowContents ignore-elements ">
                                                                <div class="rst__rowLabel ">

                                                                        <span
                                                                                class="rst__rowTitle "
                                                                                title="{{ layer.title }}"
                                                                                data-toggle="tooltip"
                                                                        >
                                      <input type="checkbox"
                                             id="{{ layer.ui_id }}"
                                             name="{{ layer.ui_id }}"
                                             onchange="toggleLayer('{{ layer.ui_id }}')" {% if layer.default_on %}
                                             checked {% endif %}/>
                                      <label for="{{ layer.ui_id }}"
                                             class="cblabel">{{ layer.title }}</label>
                                      <br/>
                                  </span>
                                                                    <div class="ignore-elements "
                                                                         style="position: relative;">
                                                                        <i id="legend_{{ layer.ui_id }}TimeLayer "
                                                                           class="fas fa-list legend-btn"
                                                                           onclick="openLegend('{{ layer.ui_id }}TimeLayer')"
                                                                           style="float: right; margin: 0 0 15px 15px;">

                                                                        </i>
                                                                        <i class="fas fa-cog settings-btn"
                                                                           onclick="openSettings('{{ layer.ui_id }}TimeLayer')"
                                                                           style="float: right; margin: 0 0 15px 15px;">

                                                                        </i>

                                                                        <input type="text"
                                                                               class="{% if layer.default_month %}monthlypicker {% else %}yearpicker {% endif %} ignore-elements  {% if not layer.default_on %}
                                                                       disabled {% endif %}"
                                                                               size="{% if layer.default_month %}6{% else %}4{% endif %}"
                                                                               id="{{ layer.ui_id }}_date"
                                                                               onclick="openPicker(this)"
                                                                               onchange="updateLayer(this);"
                                                                                {% if not layer.default_on %}
                                                                               disabled {% endif %}
                                                                               value="{% if layer.default_month %}{{ layer.default_month }}-{% endif %}{{ layer.default_year }}"
                                                                        />


                                                                    </div>
                                                                    <div class="slider-container opacity-control">
                                                                        <input type="range" min="0" max="100"
                                                                               value="100"
                                                                               class="slider opacity-control"
                                                                               style="display:block; width:100%"
                                                                               oninput="set_layer_opacity('{{ layer.ui_id }}', this.value )">
                                                                    </div>

                                                                </div>
                                                                <div class="rst__rowToolbar">
                                                                </div>
                                                            </div>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            </ol>
                        </div>


                        <div class="sidebar-pane" id="basemap">
                            <h1 class="sidebar-header" style="margin-bottom: 8px;">
                                Basemaps
                                <span class="sidebar-close">
                              <i class="fas fa-caret-left"></i>
                            </span>
                            </h1>
                        </div>
                    </div>
                </div>
                <div id="map">

                </div>
            </div>


            <div class="col-sm-12  col-xl-3 mg-t-20">
                <div class="row">
                    <div class="col-sm-12  col-xl-12 mg-t-20" id="riceAreaHolder" style="z-index: 1005;">
                        <div id="rice_area" class="chart-holder">
                        </div>

                    </div>
                    <div class="col-sm-12  col-xl-12 mg-t-20 aspect-ratio-container" id="paddyHolder"
                         style="z-index: 1004;">
                        <div id="paddy_gain" class="chart-holder"></div>
                    </div>
                    <div class="col-sm-12 col-md-12  col-xl-12 mg-t-20 " id="sparkLineHolder" style="z-index: 1003;">
                        <div id="sparklineChart" class="chart-holder">
                            <table id="sparklineTable" style="width:100%">
                                <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Annual Pattern</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Table rows will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-12 col-xl-12 mg-t-20 pie-slider order-sm-second"
                         style="z-index: 1002; border-bottom: solid 1px; border-left: solid 1px; border-right: solid 1px;">
                        <div class="form-group year-slider">
                            <h4>Select Year:</h4>
                            <div id="yearSlider"></div>
                        </div>
                        <div id="pie_chart"></div>
                    </div>
                </div>
            </div>


        </div>
        <div id="dialog" style="display: none" class="ui-widget-content dialog-max-height">
            <p>
                This is the default dialog which is useful for displaying information.
                The dialog window can be moved, resized and closed with the
                &apos;x&apos; icon.
            </p>
        </div>
        <span id="isMobile"></span>
    </div>
    <script src="{% static '/js/leaflet-sidebar.js' %}"></script>

{% endblock %}
