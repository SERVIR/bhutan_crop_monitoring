{% extends "WebApp/app_base.html" %}

{% load static %}

{% block title %}Bhutan Crop Monitoring - Map{% endblock %}
{% block script %}
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css" rel="stylesheet">

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
          integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
            integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.8/dist/esri-leaflet.js"
            integrity="sha512-E0DKVahIg0p1UHR2Kf9NX7x7TUewJb30mxkxEm2qOYTVJObgsAGpEol9F6iK6oefCbkJiA4/i6fnTHzM6H1kEA=="
            crossorigin=""></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
    <script src="{% static '/js/L.Control.Opacity.js' %}"></script>
    <link href="{% static '/css/L.Control.Opacity.css' %}" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-search/3.0.5/leaflet-search.src.js"
            integrity="sha512-PDM7dpetuBcPp2fV/ZyCj9BGV8ybPchsrSzQqVZ3WoM8YcxEa2lAj0n1+4MCRzgsEROmVTwQXGw0IrXCCgH+/Q=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{% static '/js/leaflet-providers.js' %}"></script>
    <script src="{% static 'js/boundary.js' %}"></script>

    <script src="{% static 'js/utils.js' %}"></script>

    <script src="{% static 'js/basemaps.js' %}"></script>
    <script src="{% static '/js/geosearch.umd.js' %}"></script>
    <link
            rel="stylesheet"
            href="{% static '/css/geosearch.css' %}"
    />


    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

    <script>
        let piechart;

        function buildPie() {
            piechart = Highcharts.chart('pie_chart', {
                chart: {
                    type: 'pie'
                },
                title: {
                    text: 'Rice area distribution in acres by Dzongkhag'
                },
                tooltip: {
                    useHTML: true,
                    headerFormat: '<table>',
                    footerFormat: '</table>',
                    pointFormatter: function () {
                        let dataSum = 0,
                            percentage;

                        this.series.points.forEach(function (point) {
                            dataSum += point.y;
                        });

                        percentage = ((this.y / dataSum) * 100).toFixed(2);

                        return `<tr><th colspan="2"><b>${this.name}</b></th></tr>
             <tr><th>Value:</th><td>${this.y} acres</td></tr>
             <tr><th>Percent:</th><td>${percentage}%</td></tr>`
                    }
                },
                series: [
                    {
                        name: 'Percentage',
                        colorByPoint: true,
                        data: [
                            {
                                name: 'District 1',
                                y: 4100.123
                            },
                            {
                                name: 'District 2',
                                y: 3240.2
                            },
                            {
                                name: 'District 3',
                                y: 2345.12
                            },
                            {
                                name: 'District 4',
                                y: 1345.0
                            },
                            {
                                name: 'District 5',
                                y: 500.25
                            },
                            {
                                name: 'District 6',
                                y: 1.68
                            }
                        ]
                    }
                ]
            });
        }

        function buildChart(id, title, subtitle, type, pointStart, yAxisText, rangeDescription, seriesObject, color) {
            Highcharts.chart(id, {
                    chart: {
                        type: type
                    },
                    colors: [color],
                    title: {
                        text: title,
                        align: 'left'
                    },

                    subtitle: {
                        text: subtitle,
                        align: 'left'
                    },

                    yAxis: {
                        title: {
                            text: yAxisText
                        }
                    },

                    xAxis: {
                        accessibility: {
                            rangeDescription: rangeDescription
                        }
                    },

                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle'
                    },

                    plotOptions: {
                        series: {
                            label: {
                                connectorAllowed: false
                            },
                            pointStart: pointStart,
                            tooltip: {
                                pointFormatter: function () {
                                    return this.y + " " + yAxisText;

                                }
                            },
                        }
                    },

                    series: [seriesObject],

                    responsive: {
                        rules: [{
                            condition: {
                                width: '100%',
                            },
                            chartOptions: {
                                legend: {
                                    layout: 'horizontal',
                                    align: 'center',
                                    verticalAlign: 'bottom'
                                }
                            }
                        }]
                    }

                },
                function () {
                    this.series[0].hide();
                    this.series[0].show();
                }
            );

        }

        // Function to create the table
        function createTable(data) {
            const tableContainer = document.getElementById('rice_area');
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // Create table header
            const headerRow = document.createElement('tr');
            const adminLevelHeader = document.createElement('th');
            adminLevelHeader.textContent = data.admin_level;
            headerRow.appendChild(adminLevelHeader);

            data.data[0].values.forEach(entry => {
                const yearHeader = document.createElement('th');
                yearHeader.textContent = entry.year;
                headerRow.appendChild(yearHeader);
            });
            thead.appendChild(headerRow);

            // Create table body
            data.data.forEach(item => {
                const row = document.createElement('tr');
                const adminLevelCell = document.createElement('td');
                adminLevelCell.textContent = item.name;
                row.appendChild(adminLevelCell);

                item.values.forEach(entry => {
                    const valueCell = document.createElement('td');
                    valueCell.textContent = entry.value;
                    row.appendChild(valueCell);
                });

                tbody.appendChild(row);
            });

            // Append header and body to table
            table.appendChild(thead);
            table.appendChild(tbody);

            const h4 = document.createElement('h4');

            h4.textContent = "Average rice area by " + data.admin_level;
            tableContainer.appendChild(h4);
            // Append table to container
            tableContainer.appendChild(table);
        }

        function loadGewogs(id) {
            console.log("Load Gewogs for: " + id);
        }

        $(function () {
            // Initial call to set aspect ratio on page load
            updateAspectRatio();
            buildChart('annual_ndvi', 'Annual NDVI', 'Bumthang Dzongkhag 2016: 0.213', 'line', 2016, 'NDVI', 'Range: 2016 to 2022', {
                name: 'NDVI',
                data: [0.213, -1, 0.213, 0.256, -0.014, 0.018,
                    0.199]
            }, 'rgb(44, 175, 254)');
            buildChart('annual_precipitation', 'Annual Precipitation', 'Bumthang Dzongkhag 2016: 48.010 mm', 'line', 2016, 'mm', 'Range: 2016 to 2022', {
                name: 'Precipitation',
                data: [48.01, 52.5, 50.5, 52, 73, 58.164,
                    71]
            }, 'rgb(44, 175, 254)');
            buildChart('soil_moisture', 'Annual Soil Moisture', 'Bumthang Dzongkhag 2016: 922.956 mm', 'line', 2016, 'mm', 'Range: 2016 to 2022', {
                name: 'Soil Moisture',
                data: [922.956, 1044.206, 868.699, 1034.69, 1139.746, 1026.796,
                    1203.78]
            }, 'rgb(44, 175, 254)');
            buildChart('temperature', 'Annual Temperature', 'Bumthang Dzongkhag 2016: 10.96 &deg;c', 'line', 2016, '&deg;c', 'Range: 2016 to 2022', {
                name: 'Temperature',
                data: [10.96, 10.531, 9.802, 10.854, 10.057, 9.813,
                    10.945]
            }, 'rgb(44, 175, 254)');

            buildChart('paddy_gain', 'Paddy Gain', 'Bumthang Dzongkhag 2016: 10.96 acres', 'column', 2017, 'acres', 'Range: 2016 to 2022', {
                name: 'Paddy Gain',
                data: [10.96, 10.531, 9.802, 10.854, 10.057, 9.813,
                    10.945]
            }, 'rgb(90,254,44)');

            buildChart('paddy_loss', 'Paddy Loss', 'Bumthang Dzongkhag 2016: 10.96 acres', 'column', 2017, 'acres ', 'Range: 2016 to 2022', {
                name: 'Paddy Loss',
                data: [10.96, 10.531, 9.802, 10.854, 10.057, 9.813,
                    10.945]
            }, 'rgb(255,38,0)');

            buildPie();

            map = L.map('map', {
                zoomControl: true, fullscreenControl: true, center: [27.41016657183734, 90.44523404431789], zoom: 8
            });
            map.zoomControl.setPosition('topright');
            terrainLayer.addTo(map);

            // Add the Search Control to the map
            const search = new GeoSearch.GeoSearchControl({
                provider: new GeoSearch.OpenStreetMapProvider(), showMarker: false, // optional: true|false  - default true
                showPopup: false, position: 'topright', autoClose: true,
            });
            map.addControl(search);
            var dzongkhagData = {{ dzongkhags|safe }}; // Assuming dzongkhags is a list of Dzongkhag data

            // Create an empty array to hold the GeoJSON features
            var dzongkhagFeatures = [];

            // Iterate over the Dzongkhag data
            dzongkhagData.forEach(function (dzongkhag) {
                // Create a GeoJSON feature object
                var feature = {
                    "type": "Feature",
                    "properties": {
                        "id": dzongkhag.id,
                        "name": dzongkhag.name
                    },
                    "geometry": dzongkhag.geometry
                };

                // Add the feature to the array
                dzongkhagFeatures.push(feature);
            });

            // Create a GeoJSON layer with hover and click events
            var dzongkhagLayer = L.geoJSON(dzongkhagFeatures, {
                style: function (feature) {
                    return {
                        fillColor: 'transparent', // Set fill color to 'none' to remove fill
                        color: '#0D3309', // Set border color (stroke color)
                        weight: 2 // Set border width (stroke width)
                    };
                },
                onEachFeature: function (feature, layer) {
                    // Bind a popup to the layer with the feature name
                    layer.bindPopup(feature.properties.name);

                    var popupTimer; // Variable to hold the timer for popup display

                    // Add a mouseover event listener with a delay to show the popup when hovering over the layer
                    layer.on('mouseover', function (e) {
                        popupTimer = setTimeout(function () {
                            layer.openPopup();
                        }, 300); // Adjust the delay (in milliseconds) as needed
                    });

                    // Add a mouseout event listener with a delay to hide the popup when moving away from the layer
                    layer.on('mouseout', function (e) {
                        clearTimeout(popupTimer); // Clear the popup timer
                        layer.closePopup();
                    });

                    // Add a click event listener to load Gewogs when clicking the layer
                    layer.on('click', function (e) {
                        // Call the loadGewogs function passing the ID from the clicked feature
                        loadGewogs(feature.properties.id);
                    });
                }
            }).addTo(map);

// Fit the map to the extent of the GeoJSON layer
            map.fitBounds(dzongkhagLayer.getBounds());
            $(".leaflet-bar-timecontrol").css("margin-left", "50px");
            $('.leaflet-bar-timecontrol').css('display', 'inline');
            window.dispatchEvent(new Event('resize'));

            // Sample JSON object
            const data = {
                "admin_level": "Dzongkhag",
                "data": [
                    {
                        "name": "District 1",
                        "values": [
                            {"year": 2016, "value": 100},
                            {"year": 2017, "value": 150},
                            {"year": 2018, "value": 100},
                            {"year": 2019, "value": 150},
                            {"year": 2020, "value": 100},
                            {"year": 2021, "value": 150},
                            {"year": 2022, "value": 200}
                        ]
                    },
                    {
                        "name": "District 2",
                        "values": [
                            {"year": 2016, "value": 100},
                            {"year": 2017, "value": 150},
                            {"year": 2018, "value": 100},
                            {"year": 2019, "value": 150},
                            {"year": 2020, "value": 120},
                            {"year": 2021, "value": 180},
                            {"year": 2022, "value": 220}
                        ]
                    },
                    {
                        "name": "District 3",
                        "values": [
                            {"year": 2016, "value": 100},
                            {"year": 2017, "value": 150},
                            {"year": 2018, "value": 100},
                            {"year": 2019, "value": 150},
                            {"year": 2020, "value": 100},
                            {"year": 2021, "value": 150},
                            {"year": 2022, "value": 200}
                        ]
                    },
                    {
                        "name": "District 4",
                        "values": [
                            {"year": 2016, "value": 100},
                            {"year": 2017, "value": 150},
                            {"year": 2018, "value": 100},
                            {"year": 2019, "value": 150},
                            {"year": 2020, "value": 120},
                            {"year": 2021, "value": 180},
                            {"year": 2022, "value": 220}
                        ]
                    }, {
                        "name": "District 5",
                        "values": [
                            {"year": 2016, "value": 100},
                            {"year": 2017, "value": 150},
                            {"year": 2018, "value": 100},
                            {"year": 2019, "value": 150},
                            {"year": 2020, "value": 100},
                            {"year": 2021, "value": 150},
                            {"year": 2022, "value": 200}
                        ]
                    },
                    {
                        "name": "District 6",
                        "values": [
                            {"year": 2016, "value": 100},
                            {"year": 2017, "value": 150},
                            {"year": 2018, "value": 100},
                            {"year": 2019, "value": 150},
                            {"year": 2020, "value": 120},
                            {"year": 2021, "value": 180},
                            {"year": 2022, "value": 220}
                        ]
                    }
                ]
            };

            // Call the function with your JSON data
            createTable(data);
            setupMenu();
            makeSlider();

        });

        function makeSlider() {
            // Initialize noUiSlider
            var yearSlider = document.getElementById('yearSlider');
            noUiSlider.create(yearSlider, {
                start: [2016], // Initial value
                step: 1,
                range: {
                    'min': [2016],
                    'max': [2022]
                },
                pips: {
                    mode: 'steps',
                    density: -1
                }
            });

// Listen for change event
            yearSlider.noUiSlider.on('update', function (values, handle) {
                // Output the selected year to console
                console.log('Selected year:', values[handle]);
                
                setPieYear(parseInt(values[handle]));
                
            });
        }

        function setPieYear(which) {
            console.log(which);

            var pieData = [{
                "year": 2016,
                data: [
                    {
                        name: 'District 1',
                        y: 4100.123
                    },
                    {
                        name: 'District 2',
                        y: 3240.2
                    },
                    {
                        name: 'District 3',
                        y: 2345.12
                    },
                    {
                        name: 'District 4',
                        y: 1345.0
                    },
                    {
                        name: 'District 5',
                        y: 500.25
                    },
                    {
                        name: 'District 6',
                        y: 1.68
                    }
                ]
            },
                {
                    "year": 2017,
                    data: [
                        {
                            name: 'District 1',
                            y: 400.123
                        },
                        {
                            name: 'District 2',
                            y: 1240.2
                        },
                        {
                            name: 'District 3',
                            y: 4345.12
                        },
                        {
                            name: 'District 4',
                            y: 1345.0
                        },
                        {
                            name: 'District 5',
                            y: 500.25
                        },
                        {
                            name: 'District 6',
                            y: 1.68
                        }
                    ]
                },
                {
                    "year": 2018,
                    data: [
                        {
                            name: 'District 1',
                            y: 4400.123
                        },
                        {
                            name: 'District 2',
                            y: 3440.2
                        },
                        {
                            name: 'District 3',
                            y: 2445.12
                        },
                        {
                            name: 'District 4',
                            y: 1445.0
                        },
                        {
                            name: 'District 5',
                            y: 5400.25
                        },
                        {
                            name: 'District 6',
                            y: 14.68
                        }
                    ]
                },
                {
                    "year": 2019,
                    data: [
                        {
                            name: 'District 1',
                            y: 2300.123
                        },
                        {
                            name: 'District 2',
                            y: 3740.2
                        },
                        {
                            name: 'District 3',
                            y: 2945.12
                        },
                        {
                            name: 'District 4',
                            y: 1945.0
                        },
                        {
                            name: 'District 5',
                            y: 590.25
                        },
                        {
                            name: 'District 6',
                            y: 19.68
                        }
                    ]
                },
                {
                    "year": 2020,
                    data: [
                        {
                            name: 'District 1',
                            y: 3100.123
                        },
                        {
                            name: 'District 2',
                            y: 3240.2
                        },
                        {
                            name: 'District 3',
                            y: 2345.12
                        },
                        {
                            name: 'District 4',
                            y: 2345.0
                        },
                        {
                            name: 'District 5',
                            y: 2300.25
                        },
                        {
                            name: 'District 6',
                            y: 122.68
                        }
                    ]
                },
                {
                    "year": 2021,
                    data: [
                        {
                            name: 'District 1',
                            y: 3100.123
                        },
                        {
                            name: 'District 2',
                            y: 1240.2
                        },
                        {
                            name: 'District 3',
                            y: 3345.12
                        },
                        {
                            name: 'District 4',
                            y: 2345.0
                        },
                        {
                            name: 'District 5',
                            y: 1500.25
                        },
                        {
                            name: 'District 6',
                            y: 133.68
                        }
                    ]
                },
                {
                    "year": 2022,
                    data: [
                        {
                            name: 'District 1',
                            y: 1100.123
                        },
                        {
                            name: 'District 2',
                            y: 3240.2
                        },
                        {
                            name: 'District 3',
                            y: 1345.12
                        },
                        {
                            name: 'District 4',
                            y: 3345.0
                        },
                        {
                            name: 'District 5',
                            y: 50.25
                        },
                        {
                            name: 'District 6',
                            y: 231.68
                        }
                    ]
                }];

            var newData = null;

            // Loop through pieData array to find the object with matching year
            for (var i = 0; i < pieData.length; i++) {
                if (pieData[i].year === which) {
                    newData = pieData[i].data;
                    break; // Stop loop when matching year is found
                }
            }

            piechart.series[0].setData(newData);

        }

        window.addEventListener('resize', updateAspectRatio);

        function updateAspectRatio() {
            var aspectRatio = 9 / 16; // 9:16 aspect ratio
            var containers = document.querySelectorAll('.aspect-ratio-container');
            containers.forEach(function (container) {
                var containerWidth = container.offsetWidth;
                var containerHeight = containerWidth * aspectRatio;
                container.style.height = containerHeight + 'px';
            });
        }

        const levels = {
            country: ["Bhutan"],
            dzongkhag: [
                "All Dzongkhags",
                "Bumthang",
                "Chukha",
                "Dagana",
                "Gasa",
                "Haa",
                "Lhuentse",
                "Mongar",
                "Paro",
                "Pemagatshel",
                "Punakha",
                "Samdrup Jongkhar",
                "Samtse",
                "Sarpang",
                "Thimphu",
                "Trashigang",
                "Trashiyangtse",
                "Trongsa",
                "Tsirang",
                "Wangdue Phodrang",
                "Zhemgang"
            ], // Replace with actual Dzongkhags of Bhutan
            gewog: ["walla", "whalla", "bing", "bang"], // Replace with actual Gewogs of Bhutan
        };

        let selectedValue = "Bhutan"; // Variable to store selected value

        function handleChange() {
            selectedValue = document.getElementById("levelSelect").value;
            const dropdownContainer = document.getElementById("dropdownContainer");

            if (selectedValue === "country") {
                dropdownContainer.innerHTML = `<input type="text" style="width:1px; visibility: hidden;">
                                                <select id="levelDropdown"><option>Bhutan</option></select>`; // Clear dropdown
            } else {
                const options = levels[selectedValue].map(option => `<option>${option}</option>`).join('');
                dropdownContainer.innerHTML = `<input type="text" id="filterInput" onkeyup="filterDropdown()" onfocus="openDropdown()" placeholder="Search...">
                                                  <select id="levelDropdown" onchange="updateFilter();" onclick="updateFilter();">${options}</select> `;

            }
        }

        function updateFilter() {
            const dropdown = document.getElementById("levelDropdown");
            const selectedOption = dropdown.options[dropdown.selectedIndex].textContent;
            document.getElementById("filterInput").value = selectedOption;
            closeDropdown();
        }

        function filterDropdown() {
            const input = document.getElementById("filterInput").value.toUpperCase();
            const dropdown = document.getElementById("levelDropdown");
            const options = dropdown.getElementsByTagName("option");
            let closestMatch = "";

            for (let i = 0; i < options.length; i++) {
                const text = options[i].textContent.toUpperCase();
                if (text.indexOf(input) > -1) {
                    options[i].style.display = "";
                    if (!closestMatch) {
                        closestMatch = options[i].textContent;
                    }
                } else {
                    options[i].style.display = "none";
                }
            }

            // Update selected value to the closest match
            if (closestMatch && !options.namedItem(selectedValue)) {
                dropdown.value = closestMatch;
            }
        }

        function openDropdown() {
            const dropdown = document.getElementById("levelDropdown");
            dropdown.size = dropdown.options.length;
            dropdown.style.position = "absolute"; // Position dropdown absolutely
        }

        function closeDropdown() {
            const dropdown = document.getElementById("levelDropdown");
            dropdown.size = 1;
            dropdown.style.position = ""; // Reset position
        }

        function filterOptions(optionsID, filterID) {

            var input, filter, ul, li, a, i;
            input = document.getElementById(filterID);
            filter = input.value.toUpperCase();
            ul = document.getElementById(optionsID);
            li = ul.getElementsByTagName("li");
            for (i = 1; i < li.length; i++) {
                a = li[i].getElementsByTagName("a")[0];
                if (a.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        }

        function addFilterBox(optionsID, filterID) {
            var filterInput = document.createElement("input");
            filterInput.setAttribute("class", "form-control");
            filterInput.setAttribute("type", "text");
            filterInput.setAttribute("id", filterID);
            filterInput.setAttribute("onkeyup", "filterOptions('" + optionsID + "','" + filterID + "')");
            filterInput.setAttribute("placeholder", "Search...");
            var filterLi = document.createElement("li");
            filterLi.appendChild(filterInput);
            document.getElementById(optionsID).appendChild(filterLi);
        }

        function loadGewogs(which) {
            console.log("will add Gewogs for: " + which);
            document.getElementById("gewogOptions").innerHTML = "";
            addFilterBox("gewogOptions", "gewogsFilter")

            addOptions(["All Gewogs", ...(getGewogs(which))], "gewogOptions", "gewogsFilter", 'gewog');
        }

        function getGewogs(dzongkha) {
            let country = $("#selectedCountry").text();
            if (boundary["Countries"][country][dzongkha]) {
                return boundary["Countries"][country][dzongkha];
            } else {
                return [];
            }
        }

        function loadDzongkhags(country) {
            // Clear the previous options
            document.getElementById("dzongkhagOptions").innerHTML = "";
            addFilterBox("dzongkhagOptions", "dzongkhagFilter")

            addOptions(["All Dzongkhags", ...(getDzongkhags(country))], "dzongkhagOptions", "dzongkhagFilter");
        }

        function getDzongkhags(country) {
            if (boundary["Countries"][country]) {
                return Object.keys(boundary["Countries"][country]);
            } else {
                return [];
            }
        }

        function addOptions(options, dropdownID, filterID, isGewog) {
            console.log("isGewog: " + isGewog)
            const gewog = isGewog ? "Gewog" : "";
            var ul = document.getElementById(dropdownID);
            options.forEach(function (option) {
                var li = document.createElement("li");
                var a = document.createElement("a");
                a.setAttribute("href", "#");
                a.setAttribute("class", "dropdown-item");
                a.setAttribute("onclick", "select" + gewog + "Option('" + option + "')");
                a.textContent = option;
                li.appendChild(a);
                ul.appendChild(li);
            });
        }

        function selectGewogOption(option) {
            // Update the label of the second dropdown
            document.getElementById("selectGewog").innerHTML = option;
            $("#gewogsFilter").val('');
            filterOptions('gewogOptions', 'gewogsFilter');
        }

        function selectOption(option) {
            // Update the label of the second dropdown
            document.getElementById("selectDzongkhag").innerHTML = option;
            if (option.toLowerCase() === "all dzongkhags") {
                $("#gewoglist").hide();
            } else {
                loadGewogs(option);
                document.getElementById("selectGewog").innerHTML = "All Gewogs";
                $("#gewoglist").show();
            }
            $("#dzongkhagFilter").val('');
            filterOptions('dzongkhagOptions', 'dzongkhagFilter');
        }

        function setupMenu() {
            // Get the button element
            var selectedCountryBtn = document.getElementById("selectedCountry");
            // Get the ul element
            var countryList = document.getElementById("countryList");

            // Check the number of countries
            var countryCount = Object.keys(boundary["Countries"]).length;

            // If there's only one country, set the button text to that country's name
            if (countryCount === 1) {
                var countryName = Object.keys(boundary["Countries"])[0];
                selectedCountryBtn.textContent = countryName;
                $("#selectedCountry").removeClass("dropdown-toggle");
                $("#selectedCountry").removeAttr("data-bs-toggle");
                loadDzongkhags(countryName);
            } else {
                // If there are multiple countries, set the button text to "Select Country"
                selectedCountryBtn.textContent = "Select Country";

                // Add a list of countries sorted in alphabetical order
                var countries = Object.keys(boundary["Countries"]).sort();
                countries.forEach(function (country) {
                    var li = document.createElement("li");
                    var a = document.createElement("a");
                    a.setAttribute("href", "#");
                    a.setAttribute("class", "dropdown-item");
                    a.textContent = country;
                    li.appendChild(a);
                    countryList.appendChild(li);
                });
                $("#selectedCountry").addClass("dropdown-toggle");
                $("#selectedCountry").attr("data-bs-toggle", "dropdown")
                $(countryList).removeClass("display");

            }
        }


    </script>

{% endblock %}

{% block content %}

    <div class="container-fluid p-0  bg-white">
        <div class="row" style="z-index: 1000; position: relative;">
            <div class="col-12 d-flex justify-content-center">
                <div class="row row-sm justify-content-center align-items-center"
                     style="z-index: 100; position: relative;">
                    <div class="dropdown col">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                id="selectedCountry">
                            <span class="caret"></span></button>
                        <ul id="countryList" class="dropdown-menu" aria-labelledby="selectedCountry"></ul>
                    </div>
                    <div class="dropdown col">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                id="selectDzongkhag">All Dzongkhags
                            <span class="caret"></span></button>
                        <ul class="dropdown-menu" id="dzongkhagOptions">

                        </ul>
                    </div>
                    <div class="dropdown col" id="gewoglist" style="display: none;">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                                id="selectGewog">All Gewogs
                            <span class="caret"></span></button>
                        <ul class="dropdown-menu" id="gewogOptions">

                            <!-- Options will be dynamically populated here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row row-sm">
            <div class="col-sm-6 col-xl-3 aspect-ratio-container" style="z-index: 1010;">
                <div id="annual_ndvi" class="chart-holder"></div>
            </div>
            <div class="col-sm-6 col-xl-3 mg-t-20 mg-sm-t-0 aspect-ratio-container" style="z-index: 1009;">
                <div id="annual_precipitation" class="chart-holder"></div>
            </div>
            <div class="col-sm-6 col-xl-3 mg-t-20 mg-sm-t-0 aspect-ratio-container" style="z-index: 1008;">
                <div id="soil_moisture" class="chart-holder"></div>
            </div>
            <div class="col-sm-6 col-xl-3 mg-t-20 mg-sm-t-0 aspect-ratio-container" style="z-index: 1007;">
                <div id="temperature" class="chart-holder"></div>
            </div>

            <div class="col-xl-9 mg-t-20" style="padding-left: 0; z-index: 1006;">
                <div id="map">

                </div>
            </div>
            <div class="col-sm-12  col-xl-3 mg-t-20">
                <div class="row">
                    <div class="col-sm-6  col-xl-12 mg-t-20 aspect-ratio-container" style="z-index: 1005;">
                        <div id="rice_area" class="chart-holder">
                        </div>

                    </div>
                    <div class="col-sm-6  col-xl-12 mg-t-20 aspect-ratio-container" style="z-index: 1004;">
                        <div id="paddy_gain" class="chart-holder"></div>
                    </div>
                    <div class="col-sm-6  col-xl-12 mg-t-20 aspect-ratio-container" style="z-index: 1003;">
                        <div id="paddy_loss" class="chart-holder"></div>
                    </div>


                    <div class="col-sm-6  col-xl-12 mg-t-20 pie-slider"
                         style="z-index: 1002; border-bottom: solid 1px; border-left: solid 1px; border-right: solid 1px;">
                        <div class="form-group year-slider">
                            <label for="yearSlider">Select Year:</label>
                            <div id="yearSlider"></div>
                        </div>
                        <div id="pie_chart"></div>
                    </div>
                </div>
            </div>


        </div>

    </div>


{% endblock %}
